name: Package MSIX/Appx

on:
  workflow_dispatch:

jobs:
  package:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Package Appx and optionally sign
        shell: pwsh
        run: |
          # Locate latest MakeAppx.exe and signtool.exe from Windows Kits
          $makeappx = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin\' -Recurse -Filter MakeAppx.exe |
            Sort-Object FullName -Descending | Select-Object -First 1
          $signtool = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin\' -Recurse -Filter signtool.exe |
            Sort-Object FullName -Descending | Select-Object -First 1

          if (-not $makeappx) {
            throw "MakeAppx.exe not found in Windows Kits."
          }

          Write-Output "Using MakeAppx: $($makeappx.FullName)"
          if ($signtool) {
            Write-Output "Using SignTool: $($signtool.FullName)"
          } else {
            Write-Output "SignTool not found; skipping signing."
          }

          $output = "ScoreGenius_1.10.0.0.appx"
          & $makeappx.FullName pack /d windows_package/PackageRoot /p $output

          if ($env:MSIX_CERT_PATH) {
            if (-not $signtool) {
              throw "signtool.exe missing; cannot sign."
            }
            Write-Output "Signing package with provided certificate..."
            & $signtool.FullName sign /fd SHA256 /a /f $env:MSIX_CERT_PATH /p $env:MSIX_CERT_PASSWORD $output
          } else {
            Write-Output "No certificate provided; package remains unsigned."
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: scoregenius-appx
          path: ScoreGenius_1.10.0.0.appx
