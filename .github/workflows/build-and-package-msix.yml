name: Build & Package ScoreGenius Appx

on:
  workflow_dispatch:

jobs:
  package-appx:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      FINAL_PACKAGE: ScoreGenius.appxbundle
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute dynamic version
        id: version
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $base = "1.10"
          $runnum = $env:GITHUB_RUN_NUMBER
          $version = "$base.$runnum.0"
          Write-Output "version=$version" | Out-File -Encoding ASCII -NoNewline $env:GITHUB_OUTPUT

      - name: Patch manifest version
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $manifest = "frontend/windows_package/PackageRoot/AppxManifest.xml"
          if (-not (Test-Path $manifest)) { throw "Manifest not found at $manifest" }
          $version = '${{ steps.version.outputs.version }}'
          [xml]$xml = Get-Content -Raw -Encoding UTF8 $manifest
          $xml.Package.Identity.Version = $version
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText($manifest, $xml.OuterXml, $utf8NoBom)
          Write-Output "Manifest patched to version $version"

      - name: Patch AppInstaller version + URI
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $ai = "frontend/app/ScoreGenius.appinstaller"
          if (-not (Test-Path $ai)) { throw "AppInstaller not found at $ai" }
          $version = '${{ steps.version.outputs.version }}'
          [xml]$doc = Get-Content -Raw -Encoding UTF8 $ai
          $doc.AppInstaller.Version = $version
          $doc.AppInstaller.MainPackage.Uri = "https://scoregenius.io/app/ScoreGenius.appxbundle"
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText($ai, $doc.OuterXml, $utf8NoBom)
          Write-Output "Patched AppInstaller to $version with constant URI"

      - name: Ensure loader.html exists in PackageRoot
        shell: pwsh
        run: |
          if (-not (Test-Path "frontend/windows_package/PackageRoot/loader.html")) { 
            throw "loader.html missing from PackageRoot" 
          }

      - name: Package Appxbundle and sign
        shell: pwsh
        env:
          SCOREGENIUS_PFX_B64: ${{ secrets.SCOREGENIUS_PFX_B64 }}
          SCOREGENIUS_PFX_PASSWORD: ${{ secrets.SCOREGENIUS_PFX_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          $packageRoot = 'frontend/windows_package/PackageRoot'
          $version = '${{ steps.version.outputs.version }}'
          $appxName = "ScoreGenius_${version}.appx"
          $bundleName = "ScoreGenius_${version}.appxbundle"

          # Prepare PFX
          if (-not $env:SCOREGENIUS_PFX_B64) { throw "Missing SCOREGENIUS_PFX_B64 secret" }
          $cleaned = ($env:SCOREGENIUS_PFX_B64 -replace '[^A-Za-z0-9+/=]', '')
          $pfxPath = Join-Path $env:RUNNER_TEMP "scoregenius.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($cleaned))
          certutil -f -p $env:SCOREGENIUS_PFX_PASSWORD -dump $pfxPath | Out-Null
          if ($LASTEXITCODE -ne 0) { throw "PFX failed to load; bad password or corrupted content." }

          # Locate tools
          $binRoot = 'C:\Program Files (x86)\Windows Kits\10\bin\'
          $makeappx = Get-ChildItem $binRoot -Recurse -Filter MakeAppx.exe | Sort-Object FullName -Descending | Select-Object -First 1
          $signtool = Get-ChildItem $binRoot -Recurse -Filter signtool.exe | Where-Object { $_.FullName -match '\\x64\\' } | Sort-Object FullName -Descending | Select-Object -First 1
          if (-not $makeappx) { throw "MakeAppx.exe not found." }

          # Pack .appx
          & $makeappx.FullName pack /o /d $packageRoot /p $appxName
          if (-not (Test-Path $appxName)) { throw "Packaging .appx failed." }

          # Bundle into .appxbundle
          $bundleLayout = Join-Path $env:RUNNER_TEMP "bundlelayout"
          Remove-Item -Recurse -Force $bundleLayout -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path $bundleLayout | Out-Null
          Copy-Item $appxName -Destination $bundleLayout
          & $makeappx.FullName bundle /o /bv $version /d $bundleLayout /p $bundleName
          if (-not (Test-Path $bundleName)) { throw "Bundling failed." }

          # Sign the bundle
          if ($signtool) {
            & $signtool.FullName sign /debug /fd SHA256 /a /f $pfxPath /p $env:SCOREGENIUS_PFX_PASSWORD $bundleName
            if ($LASTEXITCODE -ne 0) { throw "Signing failed with code $LASTEXITCODE" }
          }

          # Normalize filename
          Copy-Item $bundleName "ScoreGenius.appxbundle" -Force
          echo "FINAL_PACKAGE=ScoreGenius.appxbundle" | Out-File -Encoding ascii -Append $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: scoregenius-package
          path: |
            ${{ env.FINAL_PACKAGE }}
            frontend/app/ScoreGenius.appinstaller

      - name: Draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          name: "ScoreGenius v${{ steps.version.outputs.version }}"
          draft: true
          files: |
            ${{ env.FINAL_PACKAGE }}
            frontend/app/ScoreGenius.appinstaller
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
