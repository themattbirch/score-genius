name: Build & Package ScoreGenius Appx

on:
  workflow_dispatch:

jobs:
  package-appx:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute dynamic version
        id: version
        run: |
          $base = "1.10"
          $runnum = $env:GITHUB_RUN_NUMBER
          $version = "$base.$runnum.0"
          Write-Output "version=$version" | Out-File -Encoding ASCII -NoNewline $env:GITHUB_OUTPUT

      - name: Patch manifest version
        shell: pwsh
        run: |
          $manifest = "frontend/windows_package/PackageRoot/AppxManifest.xml"
          if (-not (Test-Path $manifest)) { throw "Manifest not found at $manifest" }

          $version = '${{ steps.version.outputs.version }}'

          [xml]$xml = Get-Content -Raw -Encoding UTF8 $manifest
          $xml.Package.Identity.Version = $version

          # Save back *exactly* as UTF-8 without BOM so no illegal chars creep in
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText($manifest, $xml.OuterXml, $utf8NoBom)

          Write-Output "Manifest patched to version $version"

      - name: Package Appx and sign
        shell: pwsh
        env:
          PFX_B64: ${{ secrets.SCOREGENIUS_PFX_B64 }}
          PFX_PASSWORD: ${{ secrets.SCOREGENIUS_PFX_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $packageRoot = 'frontend/windows_package/PackageRoot'
          $version = '${{ steps.version.outputs.version }}'
          $output = "ScoreGenius_${version}.appx"

          # Decode and validate PFX
          if ($env:PFX_B64) {
            $pfx = "$PWD\scoregenius.pfx"
            [IO.File]::WriteAllBytes($pfx, [Convert]::FromBase64String($env:PFX_B64))
            certutil -f -p $env:PFX_PASSWORD -dump $pfx | Out-Null
            if ($LASTEXITCODE) { throw "PFX failed to load (bad password or corrupt)." }
            Write-Output "PFX validated."
          }

          # Tools
          $makeappx = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin\' -Recurse -Filter MakeAppx.exe |
                       Sort-Object FullName -Descending | Select-Object -First 1
          $signtool = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin\' -Recurse -Filter signtool.exe |
                       Where-Object { $_.FullName -match '\\x64\\' } |
                       Sort-Object FullName -Descending | Select-Object -First 1

          # Pack
          & $makeappx.FullName pack /d $packageRoot /p $output
          if (-not (Test-Path $output)) { throw "Packaging failed." }

          # Sign
          if ($signtool -and $env:PFX_B64) {
            & $signtool.FullName sign /debug /fd SHA256 /a /f $pfx /p $env:PFX_PASSWORD $output
            if ($LASTEXITCODE) { throw "Signing failed with code $LASTEXITCODE" }
            Write-Output "Signing succeeded."
          } else {
            Write-Output "Skipping signing (signtool or PFX missing)."
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: scoregenius-appx
          path: "ScoreGenius_${{ steps.version.outputs.version }}.appx"

      - name: Draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          name: "ScoreGenius v${{ steps.version.outputs.version }}"
          draft: true
          files: "ScoreGenius_${{ steps.version.outputs.version }}.appx"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
