<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loading ScoreGenius…</title>

<!-- Minimal CSP for top-level nav -->
<meta
  http-equiv="Content-Security-Policy"
  content="default-src 'self' https:;
           script-src 'self' 'unsafe-inline';
           style-src  'self' 'unsafe-inline';
           img-src    'self' https: data:;
           connect-src https:;"
/>

<style>
  :root {
    color-scheme: dark;
  }
  html,
  body {
    height: 100%;
    margin: 0;
    background: #000;
    color: #fff;
    font: 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
      sans-serif;
  }
  .wrap {
    min-height: 100%;
    display: grid;
    place-items: center;
    padding: 24px;
    text-align: center;
  }
  h1 {
    margin: 0 0 8px 0;
    font-weight: 600;
  }
  .note {
    opacity: 0.9;
    font-size: 0.95rem;
    margin-top: 8px;
    min-height: 1.2em;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid #444;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin: 12px auto 0;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  .button {
    display: inline-block;
    padding: 12px 18px;
    border-radius: 999px;
    text-decoration: none;
    border: 1px solid #666;
    color: #000;
    background: #fff;
    font-weight: 600;
  }
  .hidden {
    display: none;
  }
</style>

<div class="wrap">
  <main role="status" aria-live="polite">
    <h1 id="msg">Loading ScoreGenius…</h1>
    <p class="note" id="step">Starting…</p>
    <div class="spinner" aria-hidden="true"></div>
    <p class="note" id="detail"></p>
    <p>
      <a
        id="fallback"
        class="button hidden"
        href="https://scoregenius.io/app/"
        target="_blank"
        rel="noopener"
        >Open in browser</a
      >
    </p>
    <noscript
      >JavaScript isn’t required —
      <a href="https://scoregenius.io/app/">open ScoreGenius</a>.</noscript
    >
  </main>
</div>

<script>
  (function () {
    const DEST = "https://scoregenius.io/app/";
    const msg = document.getElementById("msg");
    const stepEl = document.getElementById("step");
    const detail = document.getElementById("detail");
    const link = document.getElementById("fallback");

    const steps = ["Starting…", "Connecting…", "Opening app…", "Almost there…"];
    let si = 0;
    const stepTimer = setInterval(() => {
      si = (si + 1) % steps.length;
      stepEl.textContent = steps[si];
    }, 1200);

    function showFallback(title, extra) {
      if (title) msg.textContent = title;
      if (extra) detail.textContent = extra;
      link.classList.remove("hidden");
    }

    function go(href) {
      try {
        window.location.replace(href);
      } catch {
        try {
          window.location.assign(href);
        } catch {
          showFallback("Unable to open ScoreGenius.", "Navigation error.");
        }
      }
    }

    // Immediate + lifecycle + retries
    go(DEST);
    document.addEventListener("DOMContentLoaded", () => go(DEST));
    window.addEventListener("pageshow", () => go(DEST));
    const t1 = setTimeout(() => go(DEST), 250);
    const t2 = setTimeout(() => go(DEST), 2000);
    const t3 = setTimeout(() => go(DEST), 6000);
    const t4 = setTimeout(() => go(DEST), 9000); // extra late retry

    // Earlier fallback: 3s
    const stall = setTimeout(() => {
      showFallback("Still loading… you can open it directly.", "");
    }, 3000);

    // If still here at 8s, be explicit
    const hint = setTimeout(() => {
      detail.textContent = "If this screen persists, tap “Open in browser”.";
    }, 8000);

    function clearAll() {
      [t1, t2, t3, t4, stall, hint].forEach(clearTimeout);
      clearInterval(stepTimer);
    }
    window.addEventListener("pagehide", clearAll);
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") clearAll();
    });

    window.addEventListener("error", (e) =>
      showFallback("Unable to open ScoreGenius.", (e && e.message) || "Error")
    );
    window.addEventListener("unhandledrejection", (e) => {
      const r =
        (e && e.reason && (e.reason.message || e.reason)) ||
        "Promise rejection";
      showFallback("Unable to open ScoreGenius.", String(r));
    });
  })();
</script>
