<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loading ScoreGenius…</title>

<!-- CSP widened for iframe -->
<meta
  http-equiv="Content-Security-Policy"
  content="default-src 'self' https: data: blob:;
           script-src 'self' https: 'unsafe-inline' 'unsafe-eval';
           style-src  'self' https: 'unsafe-inline';
           img-src    'self' https: data: blob:;
           connect-src https:;
           frame-src https:;"
/>

<link rel="preconnect" href="https://scoregenius.io" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<style>
  :root {
    color-scheme: dark;
  }
  html,
  body {
    height: 100%;
    margin: 0;
    background: #000;
    color: #fff;
    font: 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
      sans-serif;
  }
  .root {
    position: fixed;
    inset: 0;
  }
  iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
    background: #000;
  }

  /* Overlay */
  .overlay {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    background: #000; /* seamless with splash */
    transition: opacity 0.25s ease;
  }
  .content {
    text-align: center;
    padding: 24px;
  }
  h1 {
    margin: 0 0 8px 0;
    font-weight: 600;
  }
  .note {
    opacity: 0.8;
    font-size: 0.9rem;
    margin-top: 8px;
  }
  a.button {
    display: inline-block;
    padding: 10px 16px;
    border-radius: 999px;
    text-decoration: none;
    border: 1px solid #444;
    color: inherit;
  }

  /* Spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid #444;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin: 12px auto 0;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  .hide {
    opacity: 0;
    pointer-events: none;
  }
</style>

<div class="root">
  <!-- The app loads here while we keep the overlay visible -->
  <iframe
    id="appframe"
    title="ScoreGenius"
    src="https://scoregenius.io/app/"
    allow="fullscreen"
  ></iframe>

  <!-- Extended splash / progress overlay -->
  <div id="overlay" class="overlay">
    <div class="content">
      <h1 id="msg">Loading ScoreGenius…</h1>
      <p class="note" id="step">Starting…</p>
      <div class="spinner" aria-hidden="true"></div>
      <p class="note" id="detail" aria-live="polite"></p>
      <p>
        <a
          id="fallback"
          class="button"
          href="https://scoregenius.io/app/"
          style="display: none"
          >Open in browser</a
        >
      </p>
      <noscript
        >JavaScript isn’t required —
        <a href="https://scoregenius.io/app/">open ScoreGenius</a>.</noscript
      >
    </div>
  </div>
</div>

<script>
  (function () {
    const overlay = document.getElementById("overlay");
    const frame = document.getElementById("appframe");
    const msg = document.getElementById("msg");
    const stepEl = document.getElementById("step");
    const detail = document.getElementById("detail");
    const link = document.getElementById("fallback");

    function showFallback(text, extra) {
      if (text) msg.textContent = text;
      if (extra) detail.textContent = extra;
      link.style.display = "inline-block";
    }

    // Rotating status so reviewers see motion
    const steps = [
      "Starting…",
      "Connecting to ScoreGenius…",
      "Negotiating secure session…",
      "Loading app…",
    ];
    let i = 0;
    const stepTimer = setInterval(() => {
      i = (i + 1) % steps.length;
      stepEl.textContent = steps[i];
    }, 1000);

    // If iframe errors, surface it
    frame.addEventListener("error", () =>
      showFallback("Unable to load ScoreGenius.", "Network/frame error.")
    );
    addEventListener("error", (e) =>
      showFallback(
        "Unable to load ScoreGenius.",
        "Boot error: " + (e.message || e)
      )
    );
    addEventListener("unhandledrejection", (e) => {
      const reason = (e?.reason && (e.reason.message || e.reason)) || "unknown";
      showFallback("Unable to load ScoreGenius.", "Boot promise: " + reason);
    });

    // Show fallback button early if network is slow
    const stall = setTimeout(
      () => showFallback("Still loading… you can open it directly.", ""),
      1500
    );

    // When the iframe reports load, fade out overlay (short grace so it feels intentional)
    frame.addEventListener("load", () => {
      clearTimeout(stall);
      clearInterval(stepTimer);
      setTimeout(() => overlay.classList.add("hide"), 300);
    });

    // If we ever background before ready, stop timers
    const clearAll = () => {
      clearTimeout(stall);
      clearInterval(stepTimer);
    };
    addEventListener("pagehide", clearAll);
    addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") clearAll();
    });
  })();
</script>
