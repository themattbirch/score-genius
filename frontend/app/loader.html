<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loading ScoreGenius…</title>

<!-- Safe, permissive-enough CSP for packaged webview -->
<meta
  http-equiv="Content-Security-Policy"
  content="default-src 'self' https: data: blob:;
           script-src 'self' https: 'unsafe-inline' 'unsafe-eval';
           style-src  'self' https: 'unsafe-inline';
           img-src    'self' https: data: blob:;
           connect-src https: wss:;"
/>
<meta http-equiv="refresh" content="0;url=https://scoregenius.io/app/" />

<!-- Speed up first paint by preconnecting to hosts -->
<link rel="preconnect" href="https://scoregenius.io" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<style>
  :root {
    color-scheme: dark;
  }
  html,
  body {
    height: 100%;
    margin: 0;
    background: #000;
    color: #fff;
    font: 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
      sans-serif;
  }
  .wrap {
    min-height: 100%;
    display: grid;
    place-items: center;
    padding: 24px;
    text-align: center;
  }
  a.button {
    display: inline-block;
    padding: 10px 16px;
    border-radius: 999px;
    text-decoration: none;
    border: 1px solid #444;
    color: inherit;
  }
  .note {
    opacity: 0.8;
    font-size: 0.9rem;
    margin-top: 8px;
  }

  /* Spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid #444;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin: 12px auto 0;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<div class="wrap">
  <main>
    <h1 id="msg">Loading ScoreGenius…</h1>
    <p class="note" id="step">Starting…</p>
    <div class="spinner" aria-hidden="true"></div>
    <p class="note" id="detail" aria-live="polite"></p>
    <p>
      <a
        id="fallback"
        class="button"
        href="https://scoregenius.io/app/"
        style="display: none"
      >
        Open in browser
      </a>
    </p>
    <noscript>
      JavaScript isn’t required —
      <a href="https://scoregenius.io/app/">open ScoreGenius</a>.
    </noscript>
  </main>
</div>

<script>
  (function () {
    const TARGET = "https://scoregenius.io/app/";
    const msg = document.getElementById("msg");
    const stepEl = document.getElementById("step");
    const detail = document.getElementById("detail");
    const link = document.getElementById("fallback");

    function showFallback(text, extra) {
      if (text) msg.textContent = text;
      if (extra) detail.textContent = extra;
      link.style.display = "inline-block";
    }

    // Rotate status text so reviewers see progress
    const steps = [
      "Starting…",
      "Connecting to ScoreGenius…",
      "Negotiating secure session…",
      "Loading app…",
    ];
    let i = 0;
    const stepTimer = setInterval(() => {
      i = (i + 1) % steps.length;
      stepEl.textContent = steps[i];
    }, 1000);

    // Visible diagnostics (avoid silent failures)
    addEventListener("error", (e) => {
      showFallback(
        "Unable to load ScoreGenius.",
        "Boot error: " + (e.message || e)
      );
    });
    addEventListener("unhandledrejection", (e) => {
      const reason = (e?.reason && (e.reason.message || e.reason)) || "unknown";
      showFallback("Unable to load ScoreGenius.", "Boot promise: " + reason);
    });

    // Fallback if navigation stalls (short, so it never “feels frozen”)
    const stall = setTimeout(() => {
      showFallback("Still loading… you can open it directly.", "");
    }, 1500);

    // Navigate: try assign (keeps history) then replace as belt-and-suspenders
    function navigate() {
      try {
        location.assign(TARGET);
        // If assign was blocked, try replace shortly after
        setTimeout(() => {
          if (location.href !== TARGET) location.replace(TARGET);
        }, 250);
      } catch {
        location.replace(TARGET);
      }
    }

    if (
      document.readyState === "complete" ||
      document.readyState === "interactive"
    ) {
      requestAnimationFrame(navigate);
    } else {
      addEventListener("DOMContentLoaded", () =>
        requestAnimationFrame(navigate)
      );
    }

    // Clear timers if we leave the page
    const clearAll = () => {
      clearTimeout(stall);
      clearInterval(stepTimer);
    };
    addEventListener("pagehide", clearAll);
    addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") clearAll();
    });
  })();
</script>
